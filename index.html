<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Core V10 (Dynamic Voice)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        /* --- THEME: Soft Future (Purple/Blue/Pink) --- */
        :root { 
            --glow-color: #a855f7; /* Soft Purple */
            --accent-color: #3b82f6; /* Friendly Blue */
            --bg-dark: #0f172a;    /* Deep Navy (Not harsh black) */
        }

        body { 
            margin: 0; 
            font-family: 'Exo 2', sans-serif; 
            overflow: hidden; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: white;
        }

        /* Ambient Floating Particles */
        .particle {
            position: absolute; width: 4px; height: 4px; background: white;
            border-radius: 50%; opacity: 0.3; animation: float 10s infinite;
        }
        @keyframes float { 0% { transform: translateY(0); opacity:0; } 50% { opacity:0.5; } 100% { transform: translateY(-100vh); opacity:0; } }

        /* --- THE FRIEND CORE --- */
        #core-wrapper { position: relative; width: 220px; height: 220px; margin-bottom: 30px; }

        /* Soft pulsing rings */
        .ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 2px solid var(--glow-color); box-shadow: 0 0 15px var(--glow-color);
            opacity: 0.6; transition: 0.3s;
        }
        .ring:nth-child(1) { animation: breathe 4s ease-in-out infinite; }
        .ring:nth-child(2) { inset: -15px; border: 1px dashed var(--accent-color); animation: spinSlow 20s linear infinite; opacity: 0.4; }

        #avatar-circle {
            position: absolute; inset: 10px; border-radius: 50%;
            overflow: hidden; border: 3px solid white;
            background: #000; box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        /* Hologram Filter - Friendly Version */
        #video-preview { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
            filter: contrast(1.1) brightness(1.1) hue-rotate(240deg) opacity(0.85); /* Slight blue tint, but clear */
        }

        /* Speak Animation */
        .speaking .ring:nth-child(1) { animation: speakPulse 0.5s infinite alternate; border-color: #fff; }

        /* --- CHAT INTERFACE --- */
        #ui-card {
            width: 90%; max-width: 500px; height: 60vh;
            background: rgba(15, 23, 42, 0.6); /* Glassmorphism */
            backdrop-filter: blur(12px); border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        #chat-log {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;
            scrollbar-width: none;
        }
        
        .msg {
            max-width: 80%; padding: 12px 16px; border-radius: 12px; font-size: 15px; line-height: 1.5;
            animation: slideIn 0.3s ease;
        }
        .ai { align-self: flex-start; background: rgba(168, 85, 247, 0.2); color: #e9d5ff; border-bottom-left-radius: 2px; }
        .user { align-self: flex-end; background: rgba(59, 130, 246, 0.2); color: #bfdbfe; border-bottom-right-radius: 2px; }

        /* --- INPUT --- */
        #input-area {
            padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center;
        }
        #text-input {
            flex: 1; padding: 12px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05); color: white; outline: none; font-family: inherit;
        }
        #mic-btn {
            width: 45px; height: 45px; border-radius: 50%; background: var(--glow-color); 
            border: none; color: white; cursor: pointer; font-size: 20px; transition: 0.2s;
        }
        #mic-btn:hover { transform: scale(1.1); box-shadow: 0 0 15px var(--glow-color); }
        .listening { background: #ef4444 !important; animation: pulseRed 1s infinite; }

        /* --- ANIMATIONS --- */
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.05); opacity: 0.3; } }
        @keyframes speakPulse { 0% { box-shadow: 0 0 10px var(--glow-color); transform: scale(1); } 100% { box-shadow: 0 0 40px var(--glow-color); transform: scale(1.02); } }
        @keyframes spinSlow { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }

        /* OVERLAY */
        #overlay {
            position: absolute; inset: 0; background: #020617; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 15px 40px; font-size: 18px; background: linear-gradient(45deg, var(--glow-color), var(--accent-color));
            border: none; color: white; border-radius: 30px; cursor: pointer; font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); transition: 0.3s;
        }
        #start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="margin-bottom: 10px;">Friend Core V10</h1>
        <p style="color: #94a3b8; margin-bottom: 30px;">Emotion-Adaptive Voice Engine</p>
        <button id="start-btn">Connect</button>
    </div>

    <div class="particle" style="left:10%; animation-duration:15s;"></div>
    <div class="particle" style="left:70%; animation-duration:12s; animation-delay:2s;"></div>
    <div class="particle" style="left:40%; animation-duration:18s; animation-delay:5s;"></div>

    <div id="core-wrapper">
        <div class="ring"></div>
        <div class="ring"></div>
        <div id="avatar-circle">
            <video id="video-preview" autoplay muted playsinline></video>
        </div>
    </div>

    <div id="ui-card">
        <div id="chat-log"></div>
        <div id="input-area">
            <input type="text" id="text-input" placeholder="Say hi..." autocomplete="off">
            <button id="mic-btn">üéôÔ∏è</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = 'AIzaSyCqSXWf-Cp1CHTIscrXP6BGAGLGWymr9fU'; 
        const MODEL_NAME = 'gemini-flash-latest';

        // --- STATE ---
        let chatHistory = [];
        let currentEmotion = "neutral";
        const wrapper = document.getElementById('core-wrapper');
        const chatLog = document.getElementById('chat-log');
        const video = document.getElementById('video-preview');

        // --- 1. CORE AI LOGIC ---
        async function talkToAI(text) {
            if (!text) return;
            addMsg(text, 'user');

            // Set context for friend personality
            const history = chatHistory.slice(-6).map(m => `${m.role}: ${m.text}`).join('\n');
            const prompt = `
                You are a cool, supportive digital friend. 
                - User Emotion: ${currentEmotion}
                - Tone: Casual, slangy (uses "lol", "dude", "bestie"), brief.
                - Important: If the user is SAD, be comforting. If HAPPY, be hype.
                - Output JSON format: { "reply": "your text here", "emotion": "happy/sad/neutral/excited" }
                
                History: ${history}
                User: ${text}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                let rawText = data.candidates[0].content.parts[0].text;
                
                // Clean markdown code blocks if AI adds them
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();

                let aiData;
                try {
                    aiData = JSON.parse(rawText);
                } catch (e) {
                    // Fallback if AI forgets JSON
                    aiData = { reply: rawText, emotion: "neutral" };
                }

                chatHistory.push({ role: 'User', text: text });
                chatHistory.push({ role: 'Friend', text: aiData.reply });

                addMsg(aiData.reply, 'ai');
                
                // CALL DYNAMIC VOICE
                speakDynamic(aiData.reply, aiData.emotion);

            } catch (e) {
                console.error(e);
                addMsg("My brain disconnected. Try again?", 'ai');
            }
        }

        // --- 2. DYNAMIC VOICE ENGINE ---
        function speakDynamic(text, emotion) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            
            // DEFAULT
            let pitch = 1.0;
            let rate = 1.0;

            // VOICE EMOTION MAPPING
            if (emotion.includes("happy") || emotion.includes("excited")) {
                pitch = 1.3; // Higher = Happier
                rate = 1.15; // Faster = Excited
            } else if (emotion.includes("sad") || emotion.includes("worry") || emotion.includes("comfort")) {
                pitch = 0.8; // Lower = Soothing/Sad
                rate = 0.85; // Slower = Serious
            } else if (emotion.includes("surprise")) {
                pitch = 1.4;
                rate = 1.1;
            }

            ut.pitch = pitch;
            ut.rate = rate;

            // Pick a good voice
            const voices = window.speechSynthesis.getVoices();
            const niceVoice = voices.find(v => v.name.includes("Google US English")) || voices[0];
            if(niceVoice) ut.voice = niceVoice;

            // Viseme Animation (Core Pulse)
            ut.onstart = () => wrapper.classList.add('speaking');
            ut.onend = () => wrapper.classList.remove('speaking');

            window.speechSynthesis.speak(ut);
        }

        // --- 3. VISION (EMOTION) ---
        async function initVision() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                const cam = new Camera(video, {
                    onFrame: async () => {
                        const det = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                        if (det) {
                            const ex = det.expressions;
                            const mood = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
                            
                            if (currentEmotion !== mood) {
                                currentEmotion = mood;
                                // Subtle background color shift based on mood
                                const root = document.documentElement;
                                if(mood === 'happy') root.style.setProperty('--glow-color', '#facc15'); // Yellow
                                else if(mood === 'sad') root.style.setProperty('--glow-color', '#3b82f6'); // Blue
                                else if(mood === 'angry') root.style.setProperty('--glow-color', '#ef4444'); // Red
                                else root.style.setProperty('--glow-color', '#a855f7'); // Purple (Default)
                            }
                        }
                    },
                    width: 320, height: 240
                });
                cam.start();
            } catch (e) {}
        }

        // --- 4. UTILS ---
        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // STARTUP
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            initVision();
            speakDynamic("Hey! I'm online. How's it going?", "happy");
        };

        // Inputs
        const input = document.getElementById('text-input');
        input.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') { talkToAI(input.value); input.value=''; }
        });

        // Mic
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            const rec = new Speech();
            rec.lang = 'en-US';
            const btn = document.getElementById('mic-btn');
            rec.onstart = () => btn.classList.add('listening');
            rec.onend = () => btn.classList.remove('listening');
            rec.onresult = (e) => talkToAI(e.results[0][0].transcript);
            btn.onclick = () => rec.start();
        }

    </script>
</body>
</html>
