<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeMate: Expanded</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- THEME & RESET --- */
        :root { 
            --primary: #8b5cf6;
            --glass: rgba(15, 20, 35, 0.95);
            --glow-happy: #fbbf24;
            --glow-sad: #3b82f6;
            --glow-angry: #ef4444;
            --glow-neutral: #a855f7;
            --glow-success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background: linear-gradient(45deg, #0f0c29, #302b63, #24243e);
            color: white;
            padding-top: 10px;
            transition: all 0.5s ease;
        }

        /* --- AVATAR / CAMERA --- */
        #core-wrapper { 
            position: relative; 
            width: 140px; height: 140px; 
            flex-shrink: 0;
            border-radius: 50%;
            box-shadow: 0 0 30px var(--glow-neutral);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 10px; z-index: 10;
            background: #000;
        }

        /* GUIDE MODE: BIG CAMERA */
        body.guide-active #core-wrapper {
            width: 260px; height: 260px; 
            border-radius: 20px; 
            margin-top: 10px;
            box-shadow: 0 0 60px var(--primary);
        }

        @media (min-width: 768px) {
            body.guide-active { flex-direction: row; justify-content: center; align-items: center; gap: 40px; }
            body.guide-active #core-wrapper { width: 400px; height: 300px; }
        }

        #core-wrapper.emo-happy { box-shadow: 0 0 40px var(--glow-happy); border: 2px solid var(--glow-happy); }
        #core-wrapper.speaking { animation: pulseSpeak 0.4s infinite alternate; }
        @keyframes pulseSpeak { from { transform: scale(1); } to { transform: scale(1.05); } }

        #avatar-circle {
            position: relative; width: 100%; height: 100%; border-radius: inherit; overflow: hidden; 
            border: 3px solid rgba(255,255,255,0.5); background: #000;
        }
        #video-preview, #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #face-canvas { z-index: 3; }

        /* --- UI CARD --- */
        #ui-card {
            width: 95%; max-width: 600px; 
            flex: 1; 
            margin-bottom: 15px;
            background: var(--glass); backdrop-filter: blur(15px); border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: all 0.5s ease;
            position: relative; z-index: 5;
        }

        /* GUIDE MODE ADJUSTMENTS */
        body.guide-active #ui-card { background: transparent; border: none; box-shadow: none; overflow: visible; }
        body.guide-active #chat-log, body.guide-active #voice-bar, body.guide-active #sign-container { display: none; } 
        
        body.guide-active #controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(0,0,0,0.9); border-radius: 40px;
            z-index: 100; box-shadow: 0 10px 40px black; border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- SIGN GUIDE LIBRARY --- */
        #guide-modal {
            position: absolute; inset: 0; top: 0; 
            background: transparent; z-index: 40;
            display: none; flex-direction: column; 
            height: 100%; width: 100%;
        }
        
        body.guide-active #guide-modal { display: flex; position: relative; height: auto; flex: 1; width: 100%; overflow: hidden;}

        .guide-scroll-area {
            overflow-y: auto; height: 100%; padding: 10px 20px 100px 20px; scrollbar-width: none;
        }

        .guide-section-title {
            color: #8b5cf6; font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
            margin: 20px 0 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;
        }

        .guide-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; 
        }
        
        .sign-card {
            background: rgba(255,255,255,0.1); border-radius: 16px; padding: 15px 5px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            border: 2px solid transparent; transition: all 0.3s; cursor: pointer;
        }
        
        .sign-emoji { font-size: 50px; margin-bottom: 8px; transition: transform 0.2s; }
        .sign-title { font-weight: 800; color: white; margin-bottom: 4px; font-size: 16px; text-transform: uppercase; }
        .sign-desc { font-size: 12px; color: #ccc; line-height: 1.2; padding: 0 5px;}

        .sign-card.active-match {
            background: rgba(16, 185, 129, 0.25); border-color: #10b981; transform: scale(1.05);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        /* Phrase List in Guide */
        .phrase-item {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 8px;
            font-size: 14px; color: #ddd; display: flex; align-items: center; gap: 10px;
        }
        .phrase-arrow { color: var(--primary); font-weight: bold; }

        /* --- SUBTITLE TOAST (For Guide Mode) --- */
        #subtitle-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 1px solid var(--primary);
            color: #fff; padding: 15px 25px; border-radius: 30px;
            text-align: center; font-size: 16px; font-weight: 600;
            z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #subtitle-toast.visible { opacity: 1; pointer-events: auto; }

        /* --- STANDARD UI --- */
        #voice-bar {
            display: flex; gap: 12px; padding: 15px; overflow-x: auto;
            background: rgba(0,0,0,0.2); scrollbar-width: none; flex-shrink: 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .voice-item {
            padding: 8px 16px; border-radius: 12px; background: rgba(255,255,255,0.08); 
            cursor: pointer; font-size: 13px; font-weight: 600; color: #ccc; flex-shrink: 0; white-space: nowrap;
        }
        .voice-item.active { background: var(--primary); color: white; }

        #sign-container { padding: 12px; background: rgba(0,0,0,0.4); }
        #sign-words-area { min-height: 40px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .sign-pill { background: #10b981; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 13px; animation: popIn 0.2s;}
        
        #chat-log { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scrollbar-width: none; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; }
        .ai { align-self: flex-start; background: rgba(139, 92, 246, 0.2); color: #ddd6fe; }
        .user { align-self: flex-end; background: rgba(59, 130, 246, 0.2); color: #bfdbfe; }

        #controls { padding: 12px; background: rgba(0,0,0,0.2); display: flex; gap: 8px; align-items: center; flex-shrink: 0; transition: all 0.5s; }
        #text-input { flex: 1; padding: 12px 18px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: white; outline: none; font-size: 16px; }
        .icon-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--primary); border: none; color: white; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        #overlay { position: absolute; inset: 0; background: #0f0c29; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;}
        #start-btn { margin-top: 30px; padding: 16px 45px; font-size: 18px; background: linear-gradient(90deg, #8b5cf6, #3b82f6); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: 800; display: none; }
        
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 3rem; margin: 0; background: linear-gradient(to right, #fff, #8b5cf6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VibeMate</h1>
        <p style="color: #888; margin-top: 10px;">Sign Language & Voice AI</p>
        <div id="loading-status" style="margin-top:20px; color:#8b5cf6; font-weight:bold;">Initializing...</div>
        <button id="start-btn">Start Session</button>
    </div>

    <div id="subtitle-toast"></div>

    <div id="core-wrapper">
        <div id="avatar-circle">
            <video id="video-preview" autoplay muted playsinline></video>
            <canvas id="face-canvas"></canvas>
        </div>
    </div>

    <div id="ui-card">
        
        <div id="guide-modal">
            <div class="guide-scroll-area">
                <div class="guide-section-title">Static Gestures</div>
                <div class="guide-grid" id="guide-grid"></div>

                <div class="guide-section-title">Common Phrases</div>
                <div id="phrase-list">
                    <div class="phrase-item">‚úã HELLO <span class="phrase-arrow">‚Üí</span> ‚òùÔ∏è YOU</div>
                    <div class="phrase-item">‚òùÔ∏è YOU <span class="phrase-arrow">‚Üí</span> ü§ü LOVE</div>
                    <div class="phrase-item">üõë STOP <span class="phrase-arrow">‚Üí</span> ‚úã PLEASE</div>
                    <div class="phrase-item">ü§ô CALL ME <span class="phrase-arrow">‚Üí</span> üëå OK</div>
                </div>
            </div>
        </div>

        <div id="voice-bar"></div>
        
        <div id="sign-container">
            <div id="sign-words-area">
                <span style="color:rgba(255,255,255,0.3); font-style:italic;">Signs appear here...</span>
            </div>
        </div>

        <div id="chat-log"></div>
        
        <div id="controls">
            <button id="guide-btn" class="icon-btn" style="background:#f59e0b; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);" onclick="toggleGuide()">üìö</button>
            <button id="clear-btn" class="icon-btn" style="background:#ef4444" onclick="clearSignBuffer()">üóëÔ∏è</button>
            <input type="text" id="text-input" placeholder="Type or Sign..." autocomplete="off">
            <button id="send-btn" class="icon-btn" onclick="sendInput()" style="background:#10b981">üó£Ô∏è</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const MODEL_NAME = 'llama-3.3-70b-versatile'; 
        const USER_LANGUAGE = 'en-US'; 
        let memory = JSON.parse(localStorage.getItem('vibemate_memory')) || [];
        let currentEmotion = "neutral";
        let signBuffer = [];
        let lastStableSign = null;
        let signHoldTimer = 0;
        let isGuideOpen = false;
        
        // Increased threshold for better stability (approx 1.2s)
        const CONFIRM_THRESHOLD = 12; 

        // --- DATA: SIGNS ---
        const signLibrary = [
            { id: 'HELLO', emoji: '‚úã', title: 'Hello', desc: 'Open Hand, palm forward' },
            { id: 'YES', emoji: 'üëç', title: 'Yes', desc: 'Thumbs Up' },
            { id: 'NO', emoji: '‚úä', title: 'No', desc: 'Closed Fist' },
            { id: 'OK', emoji: 'üëå', title: 'Okay', desc: 'Index touches Thumb' },
            { id: 'STOP', emoji: 'üõë', title: 'Stop', desc: 'Flat hand, palm forward' }, // Contextual: Often same as Hello but held stiffly. We will use logic to differentiate if possible or keep context.
            { id: 'LOVE', emoji: 'ü§ü', title: 'Love', desc: 'Thumb + Index + Pinky' },
            { id: 'PEACE', emoji: '‚úåÔ∏è', title: 'Peace', desc: 'V Sign with fingers' },
            { id: 'YOU', emoji: '‚òùÔ∏è', title: 'You', desc: 'Point Index Up' },
            { id: 'CALL ME', emoji: 'ü§ô', title: 'Call Me', desc: 'Thumb + Pinky extended' },
            { id: 'ROCK', emoji: 'ü§ò', title: 'Rock On', desc: 'Index + Pinky only' },
            { id: 'LEFT', emoji: 'üëà', title: 'Left', desc: 'Point Left' },
            { id: 'RIGHT', emoji: 'üëâ', title: 'Right', desc: 'Point Right' }
        ];

        // --- DATA: VOICES ---
        const voices = [
            { id: 'friend', name: 'Friend üíô', pitch: 1.0, rate: 1.0, gender: 'female', prompt: "You are a helpful, casual friend." },
            { id: 'robot', name: 'Robot ü§ñ', pitch: 0.5, rate: 1.1, gender: 'male', prompt: "I am Robot Unit 734. Affirmative." },
            { id: 'news', name: 'News üéôÔ∏è', pitch: 0.9, rate: 1.1, gender: 'male', prompt: "You are a professional News Anchor. Speak clearly and formally." },
            { id: 'granny', name: 'Granny üëµ', pitch: 1.4, rate: 0.8, gender: 'female', prompt: "You are a sweet old grandmother. Call the user 'Dearie'." },
            { id: 'wizard', name: 'Wizard üßô‚Äç‚ôÇÔ∏è', pitch: 0.4, rate: 0.7, gender: 'male', prompt: "You are a wise ancient wizard. Speak in riddles." },
            { id: 'pirate', name: 'Pirate üè¥‚Äç‚ò†Ô∏è', pitch: 0.3, rate: 0.9, gender: 'male', prompt: "Ahoy matey! Speak like a pirate." },
            { id: 'chipmunk', name: 'Chipmunk üêøÔ∏è', pitch: 2.0, rate: 1.5, gender: 'female', prompt: "You are very excited and talk fast!" },
            { id: 'alien', name: 'Alien üëΩ', pitch: 1.6, rate: 1.2, gender: 'female', prompt: "Greetings Earthling." },
        ];
        let currentVoice = 0;

        // --- DOM ---
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('face-canvas');
        const coreWrapper = document.getElementById('core-wrapper');
        const guideGrid = document.getElementById('guide-grid');
        const signArea = document.getElementById('sign-words-area');
        const chatLog = document.getElementById('chat-log');
        const subtitleToast = document.getElementById('subtitle-toast');
        const textInput = document.getElementById('text-input');
        const voiceBar = document.getElementById('voice-bar');
        const startBtn = document.getElementById('start-btn');
        const loadingStatus = document.getElementById('loading-status');

        // --- UI FUNCTIONS ---
        function setupVoiceUI() {
            voiceBar.innerHTML = '';
            voices.forEach((v, index) => {
                const el = document.createElement('div');
                el.className = `voice-item ${index === currentVoice ? 'active' : ''}`;
                el.innerText = v.name;
                el.onclick = () => {
                    currentVoice = index;
                    document.querySelectorAll('.voice-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                };
                voiceBar.appendChild(el);
            });
        }

        function setupGuideUI() {
            guideGrid.innerHTML = '';
            signLibrary.forEach(sign => {
                const card = document.createElement('div');
                card.className = 'sign-card';
                card.id = `card-${sign.id}`;
                card.innerHTML = `
                    <div class="sign-emoji">${sign.emoji}</div>
                    <div class="sign-title">${sign.title}</div>
                    <div class="sign-desc">${sign.desc}</div>
                `;
                guideGrid.appendChild(card);
            });
        }

        function toggleGuide() {
            isGuideOpen = !isGuideOpen;
            if(isGuideOpen) {
                document.body.classList.add('guide-active');
            } else {
                document.body.classList.remove('guide-active');
                subtitleToast.classList.remove('visible'); // Hide toast when leaving guide
            }
        }

        function updateSignUI() {
            signArea.innerHTML = '';
            if (signBuffer.length === 0) signArea.innerHTML = '<span style="color:rgba(255,255,255,0.3); font-style:italic;">Signs appear here...</span>';
            else {
                signBuffer.forEach(word => {
                    const span = document.createElement('span'); span.className = 'sign-pill'; span.innerText = word;
                    signArea.appendChild(span);
                });
            }
            if(signBuffer.length > 0) textInput.value = signBuffer.join(" ");
        }

        function clearSignBuffer() { signBuffer = []; textInput.value = ""; updateSignUI(); }

        function showToast(text) {
            subtitleToast.innerText = text;
            subtitleToast.classList.add('visible');
            // Auto hide after 6 seconds
            setTimeout(() => { if(subtitleToast.innerText === text) subtitleToast.classList.remove('visible'); }, 6000);
        }

        // --- VISION ---
        async function initVision() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5});
                hands.onResults(onHandResults);

                let lastProcess = 0;
                const camera = new Camera(video, {
                    onFrame: async () => {
                        const now = Date.now();
                        if (now - lastProcess < 100) return; // 10 FPS
                        lastProcess = now;
                        if(video.paused || video.ended) return;
                        await hands.send({image: video}); 
                        detectFace(); 
                    }, width: 320, height: 240
                });

                loadingStatus.innerText = "Ready.";
                startBtn.style.display = "inline-block";
                startBtn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    setupVoiceUI(); setupGuideUI(); camera.start();
                    speakHuman("Hello! I am ready to see and hear you.", "happy");
                };
            } catch(e) { console.error(e); }
        }

        const ctx = canvas.getContext('2d');
        function onHandResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelectorAll('.sign-card').forEach(c => c.classList.remove('active-match'));

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                ctx.save(); ctx.scale(-1, 1); ctx.translate(-canvas.width, 0);
                drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: 'rgba(139, 92, 246, 0.4)', lineWidth: 2});
                drawLandmarks(ctx, lm, {color: '#fbbf24', lineWidth: 1, radius: 2});
                ctx.restore();

                const sign = detectSign(lm);
                handleDetectedSign(sign);
            } else { lastStableSign = null; signHoldTimer = 0; }
        }

        function detectSign(lm) {
            const isExtended = (tip, pip) => lm[tip].y < lm[pip].y; 
            const thumbOpen = Math.abs(lm[4].x - lm[17].x) > 0.15; // Width check
            const [i, m, r, p] = [isExtended(8,6), isExtended(12,10), isExtended(16,14), isExtended(20,18)];

            // Logic Tree
            if(thumbOpen && i && m && r && p) return "HELLO"; // Open Hand (Can also be Stop, but we default Hello)
            if(!thumbOpen && i && !m && !r && !p) return "YOU"; // Index Only
            if(!thumbOpen && i && m && !r && !p) return "PEACE"; // V Sign
            if(thumbOpen && i && !m && !r && p) return "LOVE"; // ILY
            if(thumbOpen && !i && !m && !r && !p) return "YES"; // Thumbs Up
            if(!thumbOpen && !i && !m && !r && !p) return "NO"; // Fist
            if(thumbOpen && !i && !m && !r && p) return "CALL ME"; // Shaka
            if(!thumbOpen && i && !m && !r && p) return "ROCK"; // Horns
            
            // OK Sign: Thumb and Index tips close, others open
            const distThumbIndex = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            if(distThumbIndex < 0.05 && m && r && p) return "OK";

            // Directional Pointing (Using x coordinates)
            if(i && !m && !r && !p) {
                if(lm[8].x > lm[6].x + 0.1) return "LEFT"; // Mirrored
                if(lm[8].x < lm[6].x - 0.1) return "RIGHT"; // Mirrored
            }

            return null;
        }

        function handleDetectedSign(sign) {
            if(!sign) { lastStableSign = null; return; }

            // Highlight in Guide
            if(isGuideOpen) {
                const card = document.getElementById(`card-${sign}`);
                if(card) card.classList.add('active-match');
            }

            if (sign === lastStableSign) {
                signHoldTimer++;
                // Wait longer (CONFIRM_THRESHOLD)
                if (signHoldTimer >= CONFIRM_THRESHOLD) {
                    if(signBuffer.length === 0 || signBuffer[signBuffer.length-1] !== sign) {
                        if (!isGuideOpen) { signBuffer.push(sign); updateSignUI(); }
                        signHoldTimer = -20; // Longer cooldown
                        
                        // Visual Feedback of recognition
                        const card = document.getElementById(`card-${sign}`);
                        if(card) { card.style.borderColor = 'white'; setTimeout(()=>card.style.borderColor='transparent', 500); }
                    }
                }
            } else { lastStableSign = sign; signHoldTimer = 0; }
        }

        async function detectFace() {
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            if(detection) {
                const ex = detection.expressions;
                const emo = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
                if(currentEmotion !== emo) {
                    currentEmotion = emo;
                    coreWrapper.className = '';
                    if(emo === 'happy') coreWrapper.classList.add('emo-happy');
                    else if(emo === 'sad') coreWrapper.classList.add('emo-sad');
                    else if(emo === 'angry') coreWrapper.classList.add('emo-angry');
                }
            }
        }

        async function sendInput() {
            const text = textInput.value; if(!text) return;
            
            addMsg(text, 'user'); 
            memory.push({ role: 'user', content: text });
            clearSignBuffer();
            
            // If guide open, show a toast saying "Sending..."
            if(isGuideOpen) showToast("Thinking...");

            const thinkingId = addMsg("...", 'ai', true);
            
            try {
                const response = await fetch("/.netlify/functions/chat", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME, messages: [
                            { role: "system", content: `${voices[currentVoice].prompt} Output JSON: {"reply": "str", "emotion": "str"}`},
                            ...memory.slice(-5)
                        ], response_format: { type: "json_object" }
                    })
                });
                const data = await response.json();
                const aiData = JSON.parse(data.choices[0].message.content);
                
                removeMsg(thinkingId); 
                addMsg(aiData.reply, 'ai');
                memory.push({ role: 'assistant', content: aiData.reply });
                
                // Show floating subtitle if in Guide Mode
                if(isGuideOpen) showToast(aiData.reply);
                
                speakHuman(aiData.reply, aiData.emotion);
            } catch(e) { removeMsg(thinkingId); }
        }

        function speakHuman(text, emotion) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            const v = voices[currentVoice];
            ut.pitch = v.pitch + (emotion==='happy'?0.1:0); ut.rate = v.rate;
            const preferred = window.speechSynthesis.getVoices().find(x => x.name.toLowerCase().includes(v.gender));
            if(preferred) ut.voice = preferred;
            ut.onstart = () => coreWrapper.classList.add('speaking');
            ut.onend = () => coreWrapper.classList.remove('speaking');
            window.speechSynthesis.speak(ut);
        }

        function addMsg(text, type, isTemp=false) {
            const div = document.createElement('div'); div.className = `msg ${type}`; div.innerText = text;
            if(isTemp) div.id='temp-msg'; chatLog.appendChild(div); chatLog.scrollTop = chatLog.scrollHeight; return div.id;
        }
        function removeMsg(id) { const el = document.getElementById(id); if(el) el.remove(); }
        
        textInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendInput(); });
        initVision();
    </script>
</body>
</html>
