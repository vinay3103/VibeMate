<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeMate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        /* --- THEME & RESET --- */
        :root { 
            --primary: #8b5cf6;
            --glass: rgba(20, 25, 40, 0.85); /* Slightly darker for better contrast */
            --glow-happy: #fbbf24;
            --glow-sad: #3b82f6;
            --glow-angry: #ef4444;
            --glow-neutral: #a855f7;
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; 
            height: 100dvh; /* dynamic viewport height for mobile browsers */
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background: linear-gradient(45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: plasmaShift 15s ease infinite;
            color: white;
            padding-top: 20px;
        }

        /* Animation Keyframes */
        @keyframes plasmaShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulseFast { 0%, 100% { box-shadow: 0 0 40px currentColor; scale: 1; } 50% { box-shadow: 0 0 70px currentColor; scale: 1.02; } }
        @keyframes breatheDeep { 0%, 100% { box-shadow: 0 0 30px currentColor; scale: 1; } 50% { box-shadow: 0 0 60px currentColor; scale: 1.01; } }
        @keyframes shakeGlow { 0%, 100% { box-shadow: 0 0 50px currentColor; transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }

        /* --- AVATAR / CORE --- */
        #core-wrapper { 
            position: relative; 
            width: 260px; height: 260px; 
            flex-shrink: 0; /* Don't squash the face */
            border-radius: 50%;
            box-shadow: 0 0 60px var(--glow-neutral), inset 0 0 20px var(--glow-neutral);
            transition: all 0.5s ease;
            margin-bottom: 20px;
        }

        /* Responsive Avatar Size */
        @media (max-height: 700px) {
            #core-wrapper { width: 180px; height: 180px; margin-bottom: 10px; }
        }

        #core-wrapper.emo-happy { animation: pulseFast 1.5s infinite; color: var(--glow-happy); }
        #core-wrapper.emo-sad   { animation: breatheDeep 4s infinite; color: var(--glow-sad); }
        #core-wrapper.emo-angry { animation: shakeGlow 0.5s infinite; color: var(--glow-angry); }
        #core-wrapper.speaking { filter: brightness(1.3); }

        #avatar-circle {
            position: relative; width: 100%; height: 100%; border-radius: 50%; overflow: hidden; 
            border: 4px solid rgba(255,255,255,0.8); background: #000; z-index: 2;
            display: flex; justify-content: center; align-items: center;
        }
        #video-preview, #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #face-canvas { z-index: 3; }

        /* --- UI CARD --- */
        #ui-card {
            width: 90%; max-width: 500px; 
            flex: 1; /* Fill remaining height */
            margin-bottom: 20px;
            background: var(--glass); backdrop-filter: blur(20px); border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #mask-bar {
            display: flex; gap: 10px; padding: 10px 15px; overflow-x: auto;
            background: rgba(0,0,0,0.2); scrollbar-width: none; flex-shrink: 0;
        }
        .mask-item {
            font-size: 24px; width: 45px; height: 45px; border-radius: 12px;
            background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; border: 2px solid transparent; flex-shrink: 0;
        }
        .mask-item.active { border-color: var(--primary); background: rgba(139, 92, 246, 0.2); transform: scale(1.05); }

        #chat-log { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 12px; 
            scrollbar-width: none; scroll-behavior: smooth; 
        }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.4; animation: popIn 0.3s ease; word-wrap: break-word;}
        .ai { align-self: flex-start; background: rgba(139, 92, 246, 0.25); color: #ddd6fe; border-top-left-radius: 4px; }
        .user { align-self: flex-end; background: rgba(59, 130, 246, 0.25); color: #bfdbfe; border-top-right-radius: 4px; }
        
        #controls { padding: 15px; background: rgba(0,0,0,0.3); display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        #text-input { flex: 1; padding: 12px 16px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: white; outline: none; font-size: 16px; }
        .icon-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); border: none; color: white; cursor: pointer; font-size: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .listening { background: #ef4444 !important; animation: pulseRed 1s infinite; }

        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }

        /* OVERLAYS */
        #overlay { position: absolute; inset: 0; background: #000; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;}
        #start-btn { margin-top: 30px; padding: 15px 40px; font-size: 18px; background: white; color: black; border: none; border-radius: 40px; cursor: pointer; font-weight: bold; display: none; }
        #reset-mem-btn { position: absolute; top: 10px; right: 10px; opacity: 0.6; font-size: 11px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; cursor: pointer; z-index: 60;}
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 3rem; margin: 0; background: linear-gradient(to right, #fff, #8b5cf6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VibeMate</h1>
        <p style="color: #aaa; margin-top: 10px;">Emotional AI Interface</p>
        <div id="loading-status" style="margin-top:20px; color:#8b5cf6; font-weight:bold;">Initializing Neural Net...</div>
        <button id="start-btn">Enter Interface</button>
    </div>

    <button id="reset-mem-btn" onclick="clearMemory()">Clear Memory</button>

    <div id="core-wrapper">
        <div id="avatar-circle">
            <video id="video-preview" autoplay muted playsinline></video>
            <canvas id="face-canvas"></canvas>
        </div>
    </div>

    <div id="ui-card">
        <div id="mask-bar"></div>
        <div id="chat-log"></div>
        <div id="controls">
            <input type="text" id="text-input" placeholder="Type a message..." autocomplete="off">
            <button id="mic-btn" class="icon-btn">üéôÔ∏è</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script>
        // --- ‚öôÔ∏è CONFIGURATION ---
        // NOTE: No API Key here! We call our own backend now.
        const MODEL_NAME = 'llama-3.3-70b-versatile'; 
        const USER_LANGUAGE = 'en-US'; 

        // --- üß† STATE ---
        let memory = JSON.parse(localStorage.getItem('vibemate_memory')) || [];
        let currentEmotion = "neutral";
        const masks = [
            { type: 'none', emoji: 'üö´', scale: 1 },
            { type: 'monkey', emoji: 'üêµ', scale: 2.5 },
            { type: 'dog', emoji: 'üê∂', scale: 2.5 },
            { type: 'cat', emoji: 'üê±', scale: 2.4 },
            { type: 'cool', emoji: 'üòé', scale: 2.2 },
            { type: 'alien', emoji: 'üëΩ', scale: 2.2 },
            { type: 'robot', emoji: 'ü§ñ', scale: 2.4 }
        ];
        let maskIndex = 0;
        
        // DOM Elements
        const chatLog = document.getElementById('chat-log');
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('face-canvas');
        const coreWrapper = document.getElementById('core-wrapper');
        const maskBar = document.getElementById('mask-bar');
        const loadingStatus = document.getElementById('loading-status');
        const startBtn = document.getElementById('start-btn');

        // --- 1. UI SETUP ---
        function setupMaskUI() {
            maskBar.innerHTML = '';
            masks.forEach((mask, index) => {
                const el = document.createElement('div');
                el.className = `mask-item ${index === maskIndex ? 'active' : ''}`;
                el.innerText = mask.emoji;
                el.onclick = () => {
                    maskIndex = index;
                    document.querySelectorAll('.mask-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                };
                maskBar.appendChild(el);
            });
        }

        // --- 2. THE BRAIN (Now calls local backend) ---
        async function talkToAI(text) {
            if (!text) return;
            addMsg(text, 'user');
            const thinkingId = addMsg("Thinking...", 'ai', true);

            memory.push({ role: 'user', content: text });
            saveMemory();

            const systemPrompt = {
                role: "system", 
                content: `You are Vibe. User Emotion: ${currentEmotion}. Current Mask: ${masks[maskIndex].type}. Language: ${USER_LANGUAGE}. Tone: Friendly, brief, human-like. Output ONLY JSON: { "reply": "text", "emotion": "happy/sad/excited/neutral/angry" }`
            };

            try {
                // CHANGED: We now fetch our own Netlify function
                const response = await fetch("/.netlify/functions/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [systemPrompt, ...memory.slice(-8)],
                        temperature: 0.8, max_tokens: 120, response_format: { type: "json_object" }
                    })
                });

                if(!response.ok) throw new Error("Backend Error");

                const data = await response.json();
                let aiData = JSON.parse(data.choices[0].message.content);
                
                memory.push({ role: 'assistant', content: aiData.reply });
                saveMemory();

                removeMsg(thinkingId);
                addMsg(aiData.reply, 'ai');
                speakHuman(aiData.reply, aiData.emotion);

            } catch (e) { 
                console.error(e); 
                removeMsg(thinkingId); 
                addMsg("Brain freeze (Connection Error).", 'ai'); 
            }
        }

        // --- 3. SPEECH & AUDIO ---
        function speakHuman(text, emotion) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            let pitch=1.0, rate=1.0;
            if(emotion.includes('happy')) { pitch=1.1; rate=1.1; }
            if(emotion.includes('sad')) { pitch=0.9; rate=0.9; }
            
            ut.pitch=pitch; ut.rate=rate; ut.lang=USER_LANGUAGE;
            // Attempt to find a better voice
            const voices = window.speechSynthesis.getVoices();
            const bestVoice = voices.find(v => v.lang.startsWith('en') && (v.name.includes("Google") || v.name.includes("Natural")));
            if(bestVoice) ut.voice = bestVoice;

            ut.onstart = () => coreWrapper.classList.add('speaking');
            ut.onend = () => coreWrapper.classList.remove('speaking');
            window.speechSynthesis.speak(ut);
        }

        // --- 4. VISION & EMOTION ---
        async function initVision() {
            if (typeof faceapi === 'undefined') { setTimeout(initVision, 500); return; }
            loadingStatus.innerText = "Loading Vision Models...";
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                loadingStatus.innerText = "Ready!";
                startBtn.style.display = "inline-block";

                const ctx = canvas.getContext('2d');
                const cam = new Camera(video, {
                    onFrame: async () => {
                        if(video.paused || video.ended) return;
                        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions();
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        coreWrapper.classList.remove('emo-happy', 'emo-sad', 'emo-angry');

                        if (detection) {
                            const ex = detection.expressions;
                            currentEmotion = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);

                            if(currentEmotion === 'happy') coreWrapper.classList.add('emo-happy');
                            else if(currentEmotion === 'sad') coreWrapper.classList.add('emo-sad');
                            else if(currentEmotion === 'angry') coreWrapper.classList.add('emo-angry');

                            if (masks[maskIndex].type !== 'none') {
                                const nose = detection.landmarks.getNose()[3];
                                const jaw = detection.landmarks.getJawOutline();
                                const width = jaw[16].x - jaw[0].x;
                                const fontSize = width * masks[maskIndex].scale;
                                ctx.font = `${fontSize}px serif`; 
                                ctx.textAlign = "center"; 
                                ctx.textBaseline = "middle";
                                ctx.fillText(masks[maskIndex].emoji, nose.x, nose.y);
                            }
                        }
                    }, width: 320, height: 240
                });
                cam.start();
            } catch (e) { 
                console.error(e); 
                loadingStatus.innerText = "Camera Error. Check permissions."; 
            }
        }

        // --- UTILS ---
        function saveMemory() { localStorage.setItem('vibemate_memory', JSON.stringify(memory)); }
        function clearMemory() { localStorage.removeItem('vibemate_memory'); memory = []; chatLog.innerHTML = ''; addMsg("Memory wiped.", 'system'); }
        function addMsg(text, type, isTemp=false) {
            const div = document.createElement('div'); div.className = `msg ${type}`; div.innerText = text;
            if (type==='system') { div.style.background='none'; div.style.opacity='0.7'; div.style.alignSelf='center'; div.style.fontSize = '12px'; }
            if(isTemp) div.id='temp-msg'; chatLog.appendChild(div); chatLog.scrollTop = chatLog.scrollHeight; return div.id;
        }
        function removeMsg(id) { const el = document.getElementById(id); if(el) el.remove(); }

        startBtn.onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            setupMaskUI();
            if(memory.length === 0) speakHuman("Hello! I am Vibe.", "happy");
        };

        initVision();

        const input = document.getElementById('text-input');
        input.addEventListener('keypress', (e) => { if(e.key === 'Enter') { talkToAI(input.value); input.value=''; } });
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(Speech) {
            const rec = new Speech(); rec.lang = USER_LANGUAGE; const btn = document.getElementById('mic-btn');
            rec.onstart = () => btn.classList.add('listening'); rec.onend = () => btn.classList.remove('listening');
            rec.onresult = (e) => talkToAI(e.results[0][0].transcript); btn.onclick = () => rec.start();
        }
    </script>
</body>
</html>
