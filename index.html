<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeMate: Final UI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- CORE THEME --- */
        :root { 
            --primary: #8b5cf6;
            --bg-dark: #0f0c29;
            --glass: rgba(20, 25, 40, 0.95);
            --glow-happy: #fbbf24;
            --glow-sad: #3b82f6;
            --glow-angry: #ef4444;
            --glow-neutral: #a855f7;
            --glow-success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            transition: all 0.5s ease;
        }

        /* --- SCREENS (PAGES) --- */
        .screen {
            position: absolute; inset: 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0; pointer-events: none; z-index: 0;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 10; transform: scale(1); }
        .screen.hidden { transform: scale(0.95); }

        /* --- 1. START SCREEN --- */
        #screen-start { text-align: center; padding: 30px; z-index: 50; }
        #start-btn { 
            margin-top: 40px; padding: 18px 60px; font-size: 20px; 
            background: linear-gradient(90deg, #8b5cf6, #3b82f6); color: white; border: none; 
            border-radius: 50px; cursor: pointer; font-weight: 800; 
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); animation: pulseBtn 2s infinite; 
        }

        /* --- 2. MAIN INTERFACE --- */
        #screen-main { justify-content: flex-start; padding-top: 10px; }

        /* Header / Reset Button */
        #top-bar {
            width: 95%; max-width: 600px; display: flex; justify-content: space-between; align-items: center;
            padding: 10px 5px; z-index: 20;
        }
        .home-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            color: #aaa; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer;
        }

        /* Avatar */
        #core-wrapper { 
            position: relative; width: 130px; height: 130px; flex-shrink: 0; margin: 5px 0 15px 0;
            border-radius: 50%; box-shadow: 0 0 30px var(--glow-neutral);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: #000;
        }
        #avatar-circle {
            position: relative; width: 100%; height: 100%; border-radius: inherit; overflow: hidden; 
            border: 3px solid rgba(255,255,255,0.3); background: #000;
        }
        #video-preview, #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #core-wrapper.speaking { animation: pulseSpeak 0.4s infinite alternate; }
        @keyframes pulseSpeak { 0% { transform: scale(1); box-shadow: 0 0 30px currentColor; } 100% { transform: scale(1.05); box-shadow: 0 0 50px currentColor; } }

        /* Guide Mode: Expanded Avatar */
        body.guide-active #core-wrapper { width: 200px; height: 200px; border-radius: 30px; margin-top: 20px; }
        @media (min-width: 768px) { body.guide-active #core-wrapper { width: 350px; height: 260px; } }

        /* UI Card */
        #ui-card {
            width: 95%; max-width: 600px; flex: 1; min-height: 0; 
            background: var(--glass); border-radius: 24px 24px 0 0;
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex; flex-direction: column; overflow: hidden;
            position: relative; transition: all 0.3s;
        }
        /* Guide Mode: Hide main UI elements */
        body.guide-active #ui-card { background: transparent; border: none; overflow: visible; }
        body.guide-active #chat-area, body.guide-active #voice-bar, body.guide-active #sign-container { display: none; }

        /* Components */
        #voice-bar {
            display: flex; gap: 10px; padding: 12px; overflow-x: auto;
            background: rgba(0,0,0,0.3); flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.05);
            scrollbar-width: none;
        }
        .voice-item {
            padding: 8px 16px; border-radius: 12px; background: rgba(255,255,255,0.08); 
            cursor: pointer; font-size: 13px; font-weight: 600; color: #ccc; flex-shrink: 0; white-space: nowrap;
            border: 1px solid transparent; transition: 0.2s;
        }
        .voice-item.active { background: var(--primary); color: white; border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }

        #sign-container { padding: 8px 15px; background: rgba(0,0,0,0.2); flex-shrink: 0; min-height: 40px; display: flex; align-items: center;}
        #sign-words-area { display: flex; flex-wrap: wrap; gap: 6px; }
        .sign-pill { background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 13px; animation: popIn 0.3s; }

        #chat-log { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; 
            scrollbar-width: none; padding-bottom: 100px; /* Space for fixed bottom bar */
        }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
        .ai { align-self: flex-start; background: rgba(139, 92, 246, 0.25); color: #e9d5ff; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: rgba(59, 130, 246, 0.25); color: #bfdbfe; border-bottom-right-radius: 4px; }

        /* --- FIXED BOTTOM BAR (Fixed the Alignment Issue) --- */
        #controls { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 94%; max-width: 580px;
            padding: 8px; 
            background: rgba(15, 15, 25, 0.95); 
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 60px;
            display: flex; gap: 8px; align-items: center; 
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        #text-input { 
            flex: 1; min-width: 0; /* CRITICAL FIX: Prevents overflow */
            padding: 14px 20px; border-radius: 30px; 
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); 
            color: white; font-size: 16px; 
        }
        #text-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        
        .icon-btn { 
            width: 48px; height: 48px; border-radius: 50%; 
            background: var(--primary); border: none; color: white; 
            cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; 
            flex-shrink: 0; transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); }
        .secondary-btn { background: rgba(255,255,255,0.1); color: #ddd; }

        /* --- GUIDE OVERLAY --- */
        #guide-modal {
            position: absolute; inset: 0; background: rgba(15, 20, 35, 0.98); z-index: 50;
            display: none; flex-direction: column; overflow: hidden;
        }
        body.guide-active #guide-modal { display: flex; }
        
        .guide-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .close-guide-btn { background: none; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; }

        .guide-scroll { overflow-y: auto; padding: 20px; flex: 1; scrollbar-width: none; padding-bottom: 120px; }
        .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
        
        .sign-card {
            background: rgba(255,255,255,0.06); border-radius: 16px; padding: 15px;
            text-align: center; border: 2px solid transparent; transition: 0.3s;
        }
        .sign-emoji { font-size: 45px; display: block; margin-bottom: 5px;}
        .sign-title { font-weight: 700; color: white; font-size: 14px; text-transform: uppercase;}
        .sign-desc { font-size: 11px; color: #aaa; margin-top: 5px; line-height: 1.2;}
        .sign-card.active-match { border-color: #10b981; background: rgba(16, 185, 129, 0.15); transform: scale(1.05); }

        /* --- MODALS & TOASTS --- */
        #name-modal {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        #name-modal.visible { display: flex; animation: fadeIn 0.3s; }
        #name-input { padding: 15px; font-size: 18px; border-radius: 10px; border: 1px solid var(--primary); background: #222; color: white; width: 80%; margin: 20px 0; }
        
        #subtitle-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); border: 1px solid var(--primary);
            color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 15px; font-weight: 600; z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            width: max-content; max-width: 90%;
        }
        #subtitle-toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="screen-start" class="screen active">
        <h1 style="font-size: 3.5rem; margin: 0; background: linear-gradient(to right, #fff, #a78bfa); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VibeMate</h1>
        <p style="color: #94a3b8; margin-top: 10px;">AI Identity & Gesture Companion</p>
        <div id="loading-status" style="margin-top:30px; color:#8b5cf6; font-weight:bold; letter-spacing: 1px;">LOADING NEURAL NET...</div>
        <button id="start-btn" onclick="goToMain()">Start Experience</button>
    </div>

    <div id="screen-main" class="screen">
        
        <div id="top-bar">
            <button class="home-btn" onclick="resetApp()">üè†</button>
            <span style="font-size: 12px; color: #666; font-weight: bold; letter-spacing: 1px;">LIVE</span>
        </div>

        <div id="core-wrapper">
            <div id="avatar-circle">
                <video id="video-preview" autoplay muted playsinline></video>
                <canvas id="face-canvas"></canvas>
            </div>
        </div>

        <div id="ui-card">
            
            <div id="guide-modal">
                <div class="guide-header">
                    <span style="font-weight:bold; color:#ccc;">GESTURE LIBRARY</span>
                    <button class="close-guide-btn" onclick="toggleGuide()">Close Guide ‚úï</button>
                </div>
                <div class="guide-scroll">
                    <div class="guide-grid" id="guide-grid"></div>
                    
                    <h3 style="text-align:center; color:#888; text-transform:uppercase; font-size:12px; margin:20px 0 10px 0; letter-spacing:2px;">Combos</h3>
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; color:#ccc; font-size:14px; line-height:1.6;">
                        üëâ <b>Hello</b> + <b>You</b><br>
                        üëâ <b>You</b> + <b>Love</b><br>
                        üëâ <b>Call Me</b> + <b>Ok</b>
                    </div>
                </div>
            </div>

            <div id="voice-bar"></div>
            
            <div id="sign-container">
                <div id="sign-words-area">
                    <span style="color:rgba(255,255,255,0.3); font-style:italic; font-size:14px;">Gestures appear here...</span>
                </div>
            </div>

            <div id="chat-log"></div>
        </div>

        <div id="controls">
            <button id="guide-btn" class="icon-btn secondary-btn" onclick="toggleGuide()">üìö</button>
            <button id="clear-btn" class="icon-btn secondary-btn" onclick="clearSignBuffer()">üóëÔ∏è</button>
            <input type="text" id="text-input" placeholder="Type or Sign..." autocomplete="off">
            <button id="send-btn" class="icon-btn" onclick="sendInput()">üó£Ô∏è</button>
        </div>

    </div>

    <div id="name-modal">
        <h2 style="color:white; margin-bottom:10px;">Nice to meet you!</h2>
        <p style="color:#aaa;">I don't recognize you yet.</p>
        <p style="color:var(--primary); font-weight:bold;">What should I call you?</p>
        <input type="text" id="name-input" placeholder="Your Name" autocomplete="off">
        <button class="icon-btn" style="width: auto; padding: 0 30px; border-radius: 30px;" onclick="saveNewIdentity()">Save Face</button>
    </div>

    <div id="subtitle-toast">AI Reply...</div>

    <script>
        // --- CONFIG & STATE ---
        const MODEL_NAME = 'llama-3.3-70b-versatile'; 
        const USER_LANGUAGE = 'en-US'; 
        let memory = JSON.parse(localStorage.getItem('vibemate_memory')) || [];
        let knownFaces = JSON.parse(localStorage.getItem('vibemate_faces')) || []; 
        
        let currentEmotion = "neutral";
        let signBuffer = [];
        let lastStableSign = null;
        let signHoldTimer = 0;
        let isGuideOpen = false;
        
        // Identity
        let currentIdentity = "Stranger";
        let isFaceRecognitionActive = true;
        let lastRecognitionTime = 0;
        let pendingDescriptor = null;

        // --- DATA ---
        const voices = [
            { id: 'friend', name: 'Friend üíô', sample: "Hi! I'm ready to chat.", pitch: 1.0, rate: 1.0, gender: 'female', prompt: "You are a helpful friend." },
            { id: 'robot', name: 'Robot ü§ñ', sample: "System Online.", pitch: 0.5, rate: 1.1, gender: 'male', prompt: "I am Robot Unit 734." },
            { id: 'cowboy', name: 'Cowboy ü§†', sample: "Howdy partner!", pitch: 0.7, rate: 0.9, gender: 'male', prompt: "Howdy partner! Speak southern." },
            { id: 'alien', name: 'Alien üëΩ', sample: "Greetings Earthling.", pitch: 1.8, rate: 1.2, gender: 'female', prompt: "Greetings human." },
            { id: 'granny', name: 'Granny üëµ', sample: "Hello dearie!", pitch: 1.4, rate: 0.8, gender: 'female', prompt: "You are a sweet grandma." },
            { id: 'pirate', name: 'Pirate üè¥‚Äç‚ò†Ô∏è', sample: "Ahoy matey!", pitch: 0.3, rate: 0.9, gender: 'male', prompt: "Ahoy! You are a pirate." }
        ];
        let currentVoice = 0;

        const signLibrary = [
            { id: 'HELLO', emoji: '‚úã', title: 'Hello', desc: 'Open Hand' },
            { id: 'YES', emoji: 'üëç', title: 'Yes', desc: 'Thumbs Up' },
            { id: 'NO', emoji: '‚úä', title: 'No', desc: 'Closed Fist' },
            { id: 'OK', emoji: 'üëå', title: 'Okay', desc: 'Tip to Tip' },
            { id: 'LOVE', emoji: 'ü§ü', title: 'Love', desc: 'Thumb+Index+Pinky' },
            { id: 'PEACE', emoji: '‚úåÔ∏è', title: 'Peace', desc: 'V Sign' },
            { id: 'YOU', emoji: '‚òùÔ∏è', title: 'You', desc: 'Point Up' },
            { id: 'CALL ME', emoji: 'ü§ô', title: 'Call', desc: 'Thumb+Pinky' }
        ];

        // --- DOM ---
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('face-canvas');
        const coreWrapper = document.getElementById('core-wrapper');
        const guideGrid = document.getElementById('guide-grid');
        const signArea = document.getElementById('sign-words-area');
        const chatLog = document.getElementById('chat-log');
        const subtitleToast = document.getElementById('subtitle-toast');
        const textInput = document.getElementById('text-input');
        const voiceBar = document.getElementById('voice-bar');
        const startBtn = document.getElementById('start-btn');
        const loadingStatus = document.getElementById('loading-status');
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        
        // Screens
        const screenStart = document.getElementById('screen-start');
        const screenMain = document.getElementById('screen-main');

        // --- NAVIGATION ---
        function goToMain() {
            screenStart.classList.add('hidden');
            screenStart.classList.remove('active');
            
            screenMain.classList.remove('hidden');
            screenMain.classList.add('active');
            
            startCamera();
            speakHuman("Hello! I am looking for you...", "neutral");
        }

        function resetApp() {
            // Stop Camera? Optional. For now just switch screens.
            screenMain.classList.remove('active');
            screenStart.classList.remove('hidden');
            screenStart.classList.add('active');
            isFaceRecognitionActive = true;
            currentIdentity = "Stranger";
        }

        function toggleGuide() {
            isGuideOpen = !isGuideOpen;
            document.body.classList.toggle('guide-active', isGuideOpen);
            if(!isGuideOpen) subtitleToast.classList.remove('visible');
        }

        // --- SETUP ---
        function setupVoiceUI() {
            voiceBar.innerHTML = '';
            voices.forEach((v, index) => {
                const el = document.createElement('div');
                el.className = `voice-item ${index === currentVoice ? 'active' : ''}`;
                el.innerText = v.name;
                el.onclick = () => {
                    currentVoice = index;
                    document.querySelectorAll('.voice-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    speakHuman(v.sample, "happy");
                };
                voiceBar.appendChild(el);
            });
        }

        function setupGuideUI() {
            guideGrid.innerHTML = '';
            signLibrary.forEach(sign => {
                const card = document.createElement('div');
                card.className = 'sign-card';
                card.id = `card-${sign.id}`;
                card.innerHTML = `<span class="sign-emoji">${sign.emoji}</span><div class="sign-title">${sign.title}</div><div class="sign-desc">${sign.desc}</div>`;
                guideGrid.appendChild(card);
            });
        }

        function updateSignUI() {
            signArea.innerHTML = '';
            if (signBuffer.length === 0) signArea.innerHTML = '<span style="color:rgba(255,255,255,0.3); font-style:italic; font-size:14px;">Gestures appear here...</span>';
            else signBuffer.forEach(word => {
                const span = document.createElement('span'); span.className = 'sign-pill'; span.innerText = word; signArea.appendChild(span);
            });
            if(signBuffer.length > 0) textInput.value = signBuffer.join(" ");
        }

        function clearSignBuffer() { signBuffer = []; textInput.value = ""; updateSignUI(); }

        // --- VISION INIT ---
        async function initModels() {
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                loadingStatus.innerText = "READY. PRESS START.";
                startBtn.style.display = "inline-block";
                
                setupVoiceUI();
                setupGuideUI();
            } catch(e) { console.error(e); loadingStatus.innerText = "ERROR LOADING MODELS"; }
        }

        function startCamera() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5});
            hands.onResults(onHandResults);

            let lastProcess = 0;
            const camera = new Camera(video, {
                onFrame: async () => {
                    const now = Date.now();
                    if (now - lastProcess < 100) return; 
                    lastProcess = now;
                    if(video.paused || video.ended) return;
                    
                    // Match canvas size
                    canvas.width = video.videoWidth; 
                    canvas.height = video.videoHeight;

                    await hands.send({image: video}); 
                    detectFaceAndIdentity(); 
                }, width: 320, height: 240
            });
            camera.start();
        }

        // --- IDENTITY ---
        function saveNewIdentity() {
            const name = nameInput.value.trim();
            if(name && pendingDescriptor) {
                knownFaces.push({ name: name, descriptor: Array.from(pendingDescriptor) });
                localStorage.setItem('vibemate_faces', JSON.stringify(knownFaces));
                nameModal.classList.remove('visible');
                nameInput.value = "";
                currentIdentity = name;
                isFaceRecognitionActive = false; 
                speakHuman(`Nice to meet you, ${name}!`, "happy");
                addMsg(`Identity saved: ${name}`, "system");
            }
        }

        async function detectFaceAndIdentity() {
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions().withFaceDescriptor();
            if(detection) {
                // Emotion
                const ex = detection.expressions;
                const emo = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
                if(currentEmotion !== emo) {
                    currentEmotion = emo;
                    coreWrapper.className = '';
                    if(emo === 'happy') coreWrapper.classList.add('emo-happy');
                    else if(emo === 'sad') coreWrapper.classList.add('emo-sad');
                    else if(emo === 'angry') coreWrapper.classList.add('emo-angry');
                }
                // Identity
                const now = Date.now();
                if(isFaceRecognitionActive && (now - lastRecognitionTime > 2000)) {
                    lastRecognitionTime = now;
                    checkIdentity(detection.descriptor);
                }
            }
        }

        function checkIdentity(descriptor) {
            if(knownFaces.length === 0) { triggerNamePrompt(descriptor); return; }
            let bestMatch = { name: "unknown", distance: 1.0 };
            knownFaces.forEach(face => {
                const dist = faceapi.euclideanDistance(descriptor, new Float32Array(face.descriptor));
                if(dist < bestMatch.distance) bestMatch = { name: face.name, distance: dist };
            });

            if(bestMatch.distance < 0.55) {
                if(currentIdentity !== bestMatch.name) {
                    currentIdentity = bestMatch.name;
                    speakHuman(`Welcome back, ${currentIdentity}!`, "happy");
                    addMsg(`Recognized: ${currentIdentity}`, "system");
                    isFaceRecognitionActive = false; 
                }
            } else { triggerNamePrompt(descriptor); }
        }

        function triggerNamePrompt(descriptor) {
            isFaceRecognitionActive = false; 
            pendingDescriptor = descriptor;
            nameModal.classList.add('visible');
            speakHuman("I don't know you yet. What is your name?", "neutral");
        }

        // --- HANDS ---
        const ctx = canvas.getContext('2d');
        function onHandResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelectorAll('.sign-card').forEach(c => c.classList.remove('active-match'));

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                ctx.save(); ctx.scale(-1, 1); ctx.translate(-canvas.width, 0);
                drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: 'rgba(139, 92, 246, 0.4)', lineWidth: 2});
                drawLandmarks(ctx, lm, {color: '#fbbf24', lineWidth: 1, radius: 2});
                ctx.restore();

                const sign = detectSign(lm);
                if(sign) handleDetectedSign(sign);
                else { lastStableSign = null; signHoldTimer = 0; }
            }
        }

        function detectSign(lm) {
            const isExtended = (tip, pip) => lm[tip].y < lm[pip].y; 
            const thumbOpen = Math.abs(lm[4].x - lm[17].x) > 0.15;
            const [i, m, r, p] = [isExtended(8,6), isExtended(12,10), isExtended(16,14), isExtended(20,18)];
            if(thumbOpen && i && m && r && p) return "HELLO"; 
            if(!thumbOpen && i && !m && !r && !p) return "YOU"; 
            if(!thumbOpen && i && m && !r && !p) return "PEACE";
            if(thumbOpen && i && !m && !r && p) return "LOVE";
            if(thumbOpen && !i && !m && !r && !p) return "YES"; 
            if(!thumbOpen && !i && !m && !r && !p) return "NO"; 
            if(thumbOpen && !i && !m && !r && p) return "CALL ME"; 
            if(Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05 && m && r && p) return "OK";
            return null;
        }

        function handleDetectedSign(sign) {
            if(isGuideOpen) { const card = document.getElementById(`card-${sign}`); if(card) card.classList.add('active-match'); }
            if (sign === lastStableSign) {
                signHoldTimer++;
                if (signHoldTimer >= 12) { // 1.2s Hold
                    if(signBuffer.length === 0 || signBuffer[signBuffer.length-1] !== sign) {
                        if (!isGuideOpen) { signBuffer.push(sign); updateSignUI(); }
                        signHoldTimer = -20; 
                    }
                }
            } else { lastStableSign = sign; signHoldTimer = 0; }
        }

        // --- CHAT & SPEECH ---
        async function sendInput() {
            const text = textInput.value; if(!text) return;
            addMsg(text, 'user'); memory.push({ role: 'user', content: text });
            clearSignBuffer();
            
            const thinkingId = addMsg("Thinking...", 'ai', true);
            if(isGuideOpen) showToast("Thinking...");

            try {
                const response = await fetch("/.netlify/functions/chat", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME, messages: [
                            { role: "system", content: `${voices[currentVoice].prompt} User: ${currentIdentity}. Emotion: ${currentEmotion}. Output JSON: {"reply": "str", "emotion": "str"}`},
                            ...memory.slice(-6)
                        ], response_format: { type: "json_object" }
                    })
                });
                const data = await response.json();
                const aiData = JSON.parse(data.choices[0].message.content);
                removeMsg(thinkingId); addMsg(aiData.reply, 'ai');
                if(isGuideOpen) showToast(aiData.reply);
                memory.push({ role: 'assistant', content: aiData.reply });
                speakHuman(aiData.reply, aiData.emotion);
            } catch(e) { removeMsg(thinkingId); }
        }

        function speakHuman(text, emotion) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            const v = voices[currentVoice];
            ut.pitch = v.pitch + (emotion==='happy'?0.1:0); ut.rate = v.rate;
            const preferred = window.speechSynthesis.getVoices().find(x => x.name.toLowerCase().includes(v.gender));
            if(preferred) ut.voice = preferred;
            ut.onstart = () => coreWrapper.classList.add('speaking');
            ut.onend = () => coreWrapper.classList.remove('speaking');
            window.speechSynthesis.speak(ut);
        }

        function addMsg(text, type, isTemp=false) {
            const div = document.createElement('div'); div.className = `msg ${type}`; div.innerText = text;
            if(isTemp) div.id='temp-msg'; chatLog.appendChild(div); chatLog.scrollTop = chatLog.scrollHeight; return div.id;
        }
        function showToast(text) {
            subtitleToast.innerText = text; subtitleToast.classList.add('visible');
            setTimeout(() => { if(subtitleToast.innerText === text) subtitleToast.classList.remove('visible'); }, 5000);
        }
        function removeMsg(id) { const el = document.getElementById(id); if(el) el.remove(); }
        
        textInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendInput(); });
        
        // Start Model Load
        initModels();

    </script>
</body>
</html>
