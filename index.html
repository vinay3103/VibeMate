<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VibeMate: Identity AI</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* --- THEME & RESET --- */
        :root { 
            --primary: #8b5cf6;
            --bg-dark: #0f0c29;
            --glass: rgba(20, 25, 40, 0.96);
            --glow-happy: #fbbf24;
            --glow-sad: #3b82f6;
            --glow-angry: #ef4444;
            --glow-neutral: #a855f7;
            --glow-success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            transition: all 0.5s ease;
        }

        /* --- AVATAR / CAMERA --- */
        #core-wrapper { 
            position: relative; 
            width: 130px; height: 130px; 
            flex-shrink: 0; margin-top: 10px; margin-bottom: 10px;
            border-radius: 50%;
            box-shadow: 0 0 30px var(--glow-neutral);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: #000; z-index: 10;
        }

        /* Guide Mode Expansion */
        body.guide-active #core-wrapper {
            width: 220px; height: 220px; 
            border-radius: 24px; 
            box-shadow: 0 0 60px var(--primary);
        }
        @media (min-width: 768px) {
            body.guide-active { flex-direction: row; justify-content: center; gap: 40px; }
            body.guide-active #core-wrapper { width: 400px; height: 300px; }
        }

        #core-wrapper.speaking { animation: pulseSpeak 0.3s infinite alternate; }
        @keyframes pulseSpeak { 
            0% { transform: scale(1); box-shadow: 0 0 30px currentColor; } 
            100% { transform: scale(1.05); box-shadow: 0 0 50px currentColor; } 
        }

        #avatar-circle {
            position: relative; width: 100%; height: 100%; border-radius: inherit; overflow: hidden; 
            border: 3px solid rgba(255,255,255,0.3); background: #000;
        }
        #video-preview, #face-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* --- MAIN UI CARD --- */
        #ui-card {
            width: 95%; max-width: 600px; 
            flex: 1; min-height: 0; margin-bottom: 10px;
            background: var(--glass); 
            border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }

        /* Guide Mode Hiding */
        body.guide-active #ui-card { background: transparent; border: none; box-shadow: none; overflow: visible; }
        body.guide-active #chat-log, body.guide-active #voice-bar, body.guide-active #sign-container { display: none; } 

        /* --- COMPONENTS --- */
        #voice-bar {
            display: flex; gap: 10px; padding: 12px; overflow-x: auto;
            background: rgba(0,0,0,0.3); flex-shrink: 0; 
            border-bottom: 1px solid rgba(255,255,255,0.05); scrollbar-width: none;
        }
        .voice-item {
            padding: 8px 16px; border-radius: 12px; background: rgba(255,255,255,0.08); 
            cursor: pointer; font-size: 13px; font-weight: 600; color: #ccc; flex-shrink: 0; white-space: nowrap;
            border: 1px solid transparent; transition: 0.2s;
        }
        .voice-item.active { background: var(--primary); color: white; border-color: rgba(255,255,255,0.5); transform: translateY(-2px); }

        #sign-container { padding: 10px 15px; background: rgba(0,0,0,0.2); flex-shrink: 0; }
        #sign-words-area { min-height: 30px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .sign-pill { 
            background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; 
            font-weight: 700; font-size: 13px; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        #chat-log { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; scrollbar-width: none; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word;}
        .ai { align-self: flex-start; background: rgba(139, 92, 246, 0.25); color: #e9d5ff; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: rgba(59, 130, 246, 0.25); color: #bfdbfe; border-bottom-right-radius: 4px; }

        /* --- CONTROLS --- */
        #controls { 
            padding: 12px; background: rgba(10, 10, 20, 0.95); 
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 8px; align-items: center; 
            flex-shrink: 0; z-index: 20; width: 100%;
        }
        body.guide-active #controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; 
            background: rgba(0,0,0,0.9); border-radius: 50px; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #text-input { flex: 1; padding: 12px 18px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: white; font-size: 16px; }
        .icon-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--primary); border: none; color: white; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.1s;}
        .icon-btn:active { transform: scale(0.9); }

        /* --- MODALS & OVERLAYS --- */
        #guide-modal {
            position: absolute; inset: 0; background: rgba(15, 20, 35, 0.95); z-index: 50;
            display: none; flex-direction: column; overflow: hidden;
        }
        body.guide-active #guide-modal { display: flex; }
        .guide-scroll { overflow-y: auto; padding: 20px; flex: 1; scrollbar-width: none; padding-bottom: 80px;}
        .guide-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .sign-card { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 15px; text-align: center; border: 2px solid transparent; }
        .sign-emoji { font-size: 50px; display: block; margin-bottom: 5px;}
        .sign-title { font-weight: 700; color: white; font-size: 14px; text-transform: uppercase;}
        .sign-card.active-match { border-color: #10b981; background: rgba(16, 185, 129, 0.15); transform: scale(1.05); }

        /* --- NAME INPUT MODAL (New) --- */
        #name-modal {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }
        #name-modal.visible { display: flex; animation: fadeIn 0.3s; }
        #name-input { padding: 15px; font-size: 18px; border-radius: 10px; border: 1px solid var(--primary); background: #222; color: white; width: 80%; margin: 20px 0; }
        
        #subtitle-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); border: 1px solid var(--primary);
            color: #fff; padding: 12px 24px; border-radius: 30px;
            font-size: 15px; font-weight: 600; z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            width: max-content; max-width: 90%;
        }
        #subtitle-toast.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        #overlay { position: absolute; inset: 0; background: #0f0c29; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px;}
        #start-btn { margin-top: 30px; padding: 16px 50px; font-size: 18px; background: linear-gradient(90deg, #8b5cf6, #3b82f6); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: 800; display: none; box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); animation: pulseBtn 2s infinite; }
        
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 3.5rem; margin: 0; background: linear-gradient(to right, #fff, #a78bfa); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VibeMate</h1>
        <p style="color: #94a3b8; margin-top: 10px; font-size: 1.1rem;">AI Identity & Gesture Companion</p>
        <div id="loading-status" style="margin-top:30px; color:#8b5cf6; font-weight:bold; letter-spacing: 1px;">LOADING NEURAL NET...</div>
        <button id="start-btn">Start</button>
    </div>

    <div id="name-modal">
        <h2 style="color:white; margin-bottom:10px;">Nice to meet you!</h2>
        <p style="color:#aaa;">I don't recognize your face yet.</p>
        <p style="color:var(--primary); font-weight:bold;">What should I call you?</p>
        <input type="text" id="name-input" placeholder="Your Name" autocomplete="off">
        <button class="icon-btn" style="width: auto; padding: 0 30px; border-radius: 30px;" onclick="saveNewIdentity()">Save Face</button>
    </div>

    <div id="subtitle-toast">AI Reply...</div>

    <div id="core-wrapper">
        <div id="avatar-circle">
            <video id="video-preview" autoplay muted playsinline></video>
            <canvas id="face-canvas"></canvas>
        </div>
    </div>

    <div id="ui-card">
        <div id="guide-modal">
            <div class="guide-scroll">
                <h3 style="text-align:center; color:#888; text-transform:uppercase; font-size:12px; margin-bottom:15px; letter-spacing:2px;">Gesture Library</h3>
                <div class="guide-grid" id="guide-grid"></div>
                <h3 style="text-align:center; color:#888; text-transform:uppercase; font-size:12px; margin:20px 0 10px 0; letter-spacing:2px;">Combos</h3>
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; color:#ccc; font-size:14px; line-height:1.6;">
                    üëâ <b>Hello</b> + <b>You</b><br>
                    üëâ <b>You</b> + <b>Love</b><br>
                    üëâ <b>Call Me</b> + <b>Ok</b>
                </div>
            </div>
        </div>

        <div id="voice-bar"></div>
        
        <div id="sign-container">
            <div id="sign-words-area">
                <span style="color:rgba(255,255,255,0.3); font-style:italic; font-size:14px;">Gestures appear here...</span>
            </div>
        </div>

        <div id="chat-log"></div>
        
        <div id="controls">
            <button id="guide-btn" class="icon-btn" style="background:#f59e0b;" onclick="toggleGuide()">üìö</button>
            <button id="clear-btn" class="icon-btn" style="background:#ef4444;" onclick="clearSignBuffer()">üóëÔ∏è</button>
            <input type="text" id="text-input" placeholder="Type or Sign..." autocomplete="off">
            <button id="send-btn" class="icon-btn" onclick="sendInput()" style="background:#10b981;">üó£Ô∏è</button>
        </div>
    </div>

    <script>
        // --- ‚öôÔ∏è CONFIGURATION ---
        const MODEL_NAME = 'llama-3.3-70b-versatile'; 
        const USER_LANGUAGE = 'en-US'; 
        let memory = JSON.parse(localStorage.getItem('vibemate_memory')) || [];
        // Load Known Faces from LocalStorage
        let knownFaces = JSON.parse(localStorage.getItem('vibemate_faces')) || []; 
        
        let currentEmotion = "neutral";
        let signBuffer = [];
        let lastStableSign = null;
        let signHoldTimer = 0;
        let isGuideOpen = false;
        
        // Identity Logic
        let currentIdentity = "Stranger";
        let isFaceRecognitionActive = true;
        let lastRecognitionTime = 0;
        let pendingDescriptor = null; // Temp storage while typing name

        // --- üß† VOICES & SIGNS ---
        const voices = [
            { id: 'friend', name: 'Friend üíô', sample: "Hi there! I'm ready.", pitch: 1.0, rate: 1.0, gender: 'female', prompt: "You are a helpful friend." },
            { id: 'robot', name: 'Robot ü§ñ', sample: "System Online.", pitch: 0.5, rate: 1.1, gender: 'male', prompt: "I am Robot Unit 734." },
            { id: 'cowboy', name: 'Cowboy ü§†', sample: "Howdy partner!", pitch: 0.7, rate: 0.9, gender: 'male', prompt: "Howdy partner! Speak southern." },
            { id: 'alien', name: 'Alien üëΩ', sample: "Greetings Earthling.", pitch: 1.8, rate: 1.2, gender: 'female', prompt: "Greetings human." },
            { id: 'granny', name: 'Granny üëµ', sample: "Hello dearie!", pitch: 1.4, rate: 0.8, gender: 'female', prompt: "You are a sweet grandma." },
            { id: 'pirate', name: 'Pirate üè¥‚Äç‚ò†Ô∏è', sample: "Ahoy matey!", pitch: 0.3, rate: 0.9, gender: 'male', prompt: "Ahoy! You are a pirate." }
        ];
        let currentVoice = 0;

        const signLibrary = [
            { id: 'HELLO', emoji: '‚úã', title: 'Hello', desc: 'Open Hand' },
            { id: 'YES', emoji: 'üëç', title: 'Yes', desc: 'Thumbs Up' },
            { id: 'NO', emoji: '‚úä', title: 'No', desc: 'Closed Fist' },
            { id: 'OK', emoji: 'üëå', title: 'Okay', desc: 'Tip to Tip' },
            { id: 'LOVE', emoji: 'ü§ü', title: 'Love', desc: 'Thumb+Index+Pinky' },
            { id: 'PEACE', emoji: '‚úåÔ∏è', title: 'Peace', desc: 'V Sign' },
            { id: 'YOU', emoji: '‚òùÔ∏è', title: 'You', desc: 'Point Up' },
            { id: 'CALL ME', emoji: 'ü§ô', title: 'Call', desc: 'Thumb+Pinky' }
        ];

        // --- DOM ---
        const video = document.getElementById('video-preview');
        const canvas = document.getElementById('face-canvas');
        const coreWrapper = document.getElementById('core-wrapper');
        const guideGrid = document.getElementById('guide-grid');
        const signArea = document.getElementById('sign-words-area');
        const chatLog = document.getElementById('chat-log');
        const subtitleToast = document.getElementById('subtitle-toast');
        const textInput = document.getElementById('text-input');
        const voiceBar = document.getElementById('voice-bar');
        const startBtn = document.getElementById('start-btn');
        const loadingStatus = document.getElementById('loading-status');
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');

        // --- 1. UI SETUP ---
        function setupVoiceUI() {
            voiceBar.innerHTML = '';
            voices.forEach((v, index) => {
                const el = document.createElement('div');
                el.className = `voice-item ${index === currentVoice ? 'active' : ''}`;
                el.innerText = v.name;
                el.onclick = () => {
                    currentVoice = index;
                    document.querySelectorAll('.voice-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    speakHuman(v.sample, "happy");
                };
                voiceBar.appendChild(el);
            });
        }

        function setupGuideUI() {
            guideGrid.innerHTML = '';
            signLibrary.forEach(sign => {
                const card = document.createElement('div');
                card.className = 'sign-card';
                card.id = `card-${sign.id}`;
                card.innerHTML = `<span class="sign-emoji">${sign.emoji}</span><div class="sign-title">${sign.title}</div><div class="sign-desc">${sign.desc}</div>`;
                guideGrid.appendChild(card);
            });
        }

        function toggleGuide() {
            isGuideOpen = !isGuideOpen;
            document.body.classList.toggle('guide-active', isGuideOpen);
            if(!isGuideOpen) subtitleToast.classList.remove('visible');
        }

        function showToast(text) {
            subtitleToast.innerText = text; subtitleToast.classList.add('visible');
            setTimeout(() => { if(subtitleToast.innerText === text) subtitleToast.classList.remove('visible'); }, 5000);
        }

        function updateSignUI() {
            signArea.innerHTML = '';
            if (signBuffer.length === 0) signArea.innerHTML = '<span style="color:rgba(255,255,255,0.3); font-style:italic; font-size:14px;">Gestures appear here...</span>';
            else signBuffer.forEach(word => {
                const span = document.createElement('span'); span.className = 'sign-pill'; span.innerText = word; signArea.appendChild(span);
            });
            if(signBuffer.length > 0) textInput.value = signBuffer.join(" ");
        }

        function clearSignBuffer() { signBuffer = []; textInput.value = ""; updateSignUI(); }

        // --- 2. INITIALIZATION ---
        async function initVision() {
            try {
                // Load ALL required models
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5});
                hands.onResults(onHandResults);

                let lastProcess = 0;
                const camera = new Camera(video, {
                    onFrame: async () => {
                        const now = Date.now();
                        if (now - lastProcess < 100) return; 
                        lastProcess = now;
                        if(video.paused || video.ended) return;
                        await hands.send({image: video}); 
                        detectFaceAndIdentity(); 
                    }, width: 320, height: 240
                });

                loadingStatus.innerText = "READY";
                startBtn.style.display = "inline-block";
                startBtn.onclick = () => {
                    document.getElementById('overlay').style.display = 'none';
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    setupVoiceUI(); setupGuideUI(); camera.start();
                    speakHuman("Hello! Looking for you...", "neutral");
                };
            } catch(e) { console.error(e); loadingStatus.innerText = "ERROR: REFRESH PAGE"; }
        }

        // --- 3. IDENTITY LOGIC ---
        function saveNewIdentity() {
            const name = nameInput.value.trim();
            if(name && pendingDescriptor) {
                // Convert Float32Array to standard array for JSON storage
                const descriptorArray = Array.from(pendingDescriptor);
                knownFaces.push({ name: name, descriptor: descriptorArray });
                localStorage.setItem('vibemate_faces', JSON.stringify(knownFaces));
                
                nameModal.classList.remove('visible');
                nameInput.value = "";
                currentIdentity = name;
                isFaceRecognitionActive = false; // Stop checking once identified
                
                speakHuman(`Nice to meet you, ${name}! I will remember you.`, "happy");
                addMsg(`Identity saved: ${name}`, "system");
            }
        }

        async function detectFaceAndIdentity() {
            // Full detection including Descriptor
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceExpressions()
                .withFaceDescriptor();

            if(detection) {
                // Emotion
                const ex = detection.expressions;
                const emo = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
                if(currentEmotion !== emo) {
                    currentEmotion = emo;
                    coreWrapper.className = '';
                    if(emo === 'happy') coreWrapper.classList.add('emo-happy');
                    else if(emo === 'sad') coreWrapper.classList.add('emo-sad');
                    else if(emo === 'angry') coreWrapper.classList.add('emo-angry');
                }

                // Identity Check (Run every 2 seconds if active)
                const now = Date.now();
                if(isFaceRecognitionActive && (now - lastRecognitionTime > 2000)) {
                    lastRecognitionTime = now;
                    checkIdentity(detection.descriptor);
                }
            }
        }

        function checkIdentity(descriptor) {
            if(knownFaces.length === 0) {
                // No known faces -> Prompt for name
                triggerNamePrompt(descriptor);
                return;
            }

            let bestMatch = { name: "unknown", distance: 1.0 };
            
            // Compare against all stored faces
            knownFaces.forEach(face => {
                // Convert back to Float32 for math
                const storedDescriptor = new Float32Array(face.descriptor);
                const distance = faceapi.euclideanDistance(descriptor, storedDescriptor);
                if(distance < bestMatch.distance) {
                    bestMatch = { name: face.name, distance: distance };
                }
            });

            // Threshold for recognition (0.6 is standard)
            if(bestMatch.distance < 0.55) {
                if(currentIdentity !== bestMatch.name) {
                    currentIdentity = bestMatch.name;
                    speakHuman(`Welcome back, ${currentIdentity}!`, "happy");
                    addMsg(`Recognized: ${currentIdentity}`, "system");
                    isFaceRecognitionActive = false; // Stop checking for this session
                }
            } else {
                // Unknown face found
                triggerNamePrompt(descriptor);
            }
        }

        function triggerNamePrompt(descriptor) {
            // Pause recognition so we don't spam the modal
            isFaceRecognitionActive = false; 
            pendingDescriptor = descriptor;
            nameModal.classList.add('visible');
            speakHuman("I don't know you yet. What is your name?", "neutral");
        }

        // --- 4. HAND GESTURES ---
        const ctx = canvas.getContext('2d');
        function onHandResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelectorAll('.sign-card').forEach(c => c.classList.remove('active-match'));

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                ctx.save(); ctx.scale(-1, 1); ctx.translate(-canvas.width, 0);
                drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: 'rgba(139, 92, 246, 0.4)', lineWidth: 2});
                drawLandmarks(ctx, lm, {color: '#fbbf24', lineWidth: 1, radius: 2});
                ctx.restore();

                const sign = detectSign(lm);
                if(sign) handleDetectedSign(sign);
                else { lastStableSign = null; signHoldTimer = 0; }
            }
        }

        function detectSign(lm) {
            const isExtended = (tip, pip) => lm[tip].y < lm[pip].y; 
            const thumbOpen = Math.abs(lm[4].x - lm[17].x) > 0.15;
            const [i, m, r, p] = [isExtended(8,6), isExtended(12,10), isExtended(16,14), isExtended(20,18)];

            if(thumbOpen && i && m && r && p) return "HELLO"; 
            if(!thumbOpen && i && !m && !r && !p) return "YOU"; 
            if(!thumbOpen && i && m && !r && !p) return "PEACE";
            if(thumbOpen && i && !m && !r && p) return "LOVE";
            if(thumbOpen && !i && !m && !r && !p) return "YES"; 
            if(!thumbOpen && !i && !m && !r && !p) return "NO"; 
            if(thumbOpen && !i && !m && !r && p) return "CALL ME"; 
            const dist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
            if(dist < 0.05 && m && r && p) return "OK";
            return null;
        }

        function handleDetectedSign(sign) {
            if(isGuideOpen) {
                const card = document.getElementById(`card-${sign}`);
                if(card) card.classList.add('active-match');
            }

            if (sign === lastStableSign) {
                signHoldTimer++;
                if (signHoldTimer >= 12) { 
                    if(signBuffer.length === 0 || signBuffer[signBuffer.length-1] !== sign) {
                        if (!isGuideOpen) { signBuffer.push(sign); updateSignUI(); }
                        signHoldTimer = -20; 
                    }
                }
            } else { lastStableSign = sign; signHoldTimer = 0; }
        }

        // --- 5. CHAT ---
        async function sendInput() {
            const text = textInput.value; if(!text) return;
            addMsg(text, 'user'); memory.push({ role: 'user', content: text });
            clearSignBuffer();
            const thinkingId = addMsg("Thinking...", 'ai', true);
            if(isGuideOpen) showToast("Thinking...");

            try {
                const response = await fetch("/.netlify/functions/chat", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL_NAME, messages: [
                            { role: "system", content: `${voices[currentVoice].prompt} User Name: ${currentIdentity}. User Emotion: ${currentEmotion}. Output JSON: {"reply": "str", "emotion": "str"}`},
                            ...memory.slice(-6)
                        ], response_format: { type: "json_object" }
                    })
                });
                const data = await response.json();
                const aiData = JSON.parse(data.choices[0].message.content);
                removeMsg(thinkingId); addMsg(aiData.reply, 'ai');
                if(isGuideOpen) showToast(aiData.reply);
                memory.push({ role: 'assistant', content: aiData.reply });
                speakHuman(aiData.reply, aiData.emotion);
            } catch(e) { removeMsg(thinkingId); }
        }

        function speakHuman(text, emotion) {
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            const v = voices[currentVoice];
            ut.pitch = v.pitch + (emotion==='happy'?0.1:0); ut.rate = v.rate;
            const preferred = window.speechSynthesis.getVoices().find(x => x.name.toLowerCase().includes(v.gender));
            if(preferred) ut.voice = preferred;
            ut.onstart = () => coreWrapper.classList.add('speaking');
            ut.onend = () => coreWrapper.classList.remove('speaking');
            window.speechSynthesis.speak(ut);
        }

        function addMsg(text, type, isTemp=false) {
            const div = document.createElement('div'); div.className = `msg ${type}`; div.innerText = text;
            if(isTemp) div.id='temp-msg'; chatLog.appendChild(div); chatLog.scrollTop = chatLog.scrollHeight; return div.id;
        }
        function removeMsg(id) { const el = document.getElementById(id); if(el) el.remove(); }
        
        textInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendInput(); });
        initVision();
    </script>
</body>
</html>
